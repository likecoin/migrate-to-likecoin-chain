<template>
  <v-container
    class="blue-grey lighten-5 pa-0 pb-12 fill-height d-block"
    fluid
  >
    <v-row
      class="white"
      justify="center"
    >
      <v-col
        class="px-8"
        cols="12"
        md="8"
        sm="10"
      >
        <img src="~/assets/images/app-logo.svg">
      </v-col>
    </v-row>
    <v-row
      class="primary"
      justify="center"
    >
      <v-col
        class="pt-sm-0 pt-6 pa-8 pb-12 secondary--text"
        cols="12"
        md="8"
        sm="10"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="100%" viewBox="0 0 570 178">
          <g style="fill: currentColor">
            <circle cx="416" cy="83" r="3" />
            <circle cx="156" cy="123" r="3" />
            <circle cx="70" cy="104" r="3" />
            <circle cx="524" cy="101" r="3" />
            <circle cx="387" cy="149" r="3" />
            <circle cx="446.5" cy="118.5" r="4.5" />
            <circle cx="193.5" cy="43.5" r="4.5" />
          </g>
          <g style="fill: white">
            <g style="fill-rule: evenodd">
              <!-- eslint-disable max-len -->
              <path d="M286.42,75.31a21.27,21.27,0,0,1-4.18,5,1,1,0,0,0-.08,1.42,1,1,0,0,0,.73.34,1,1,0,0,0,.64-.25,23.27,23.27,0,0,0,4.57-5.47c.2-.35.73-1.14,1.52-1a1,1,0,0,0,1.09-.86,1,1,0,0,0-.83-1.13,3.44,3.44,0,0,0-3.46,2" />
              <path d="M265.33,98.42a1,1,0,0,0,.79.37,1,1,0,0,0,.65-.24,26.36,26.36,0,0,1,3.37-2.23,1,1,0,0,0,.45-1.36,1,1,0,0,0-1.37-.45A29,29,0,0,0,265.46,97a1,1,0,0,0-.13,1.42" />
              <path d="M297,93c-2.7,3-5.41,4.65-10.61,7.35a9.14,9.14,0,0,0-4,3.23c-.75,1.26-1,1.67-1.05,1.83a1.26,1.26,0,0,0,.55,1.68,1.24,1.24,0,0,0,.53.12,1.22,1.22,0,0,0,1.13-.76s0,0,.94-1.62a7.09,7.09,0,0,1,3.07-2.7,30.07,30.07,0,0,0,10.36-7.25,34.46,34.46,0,0,0,3.81-5.19c1.45-2.44.69-4.53-.62-4.89a.17.17,0,0,1-.11-.25,12.89,12.89,0,0,0,1.67-3.86,2.47,2.47,0,0,0-1.84-3.18.16.16,0,0,1-.12-.2c.11-.4.22-.91.29-1.24a2.82,2.82,0,0,0-1.93-3.4,2.9,2.9,0,0,0-2.34.49.23.23,0,0,1-.31,0,1.8,1.8,0,0,0-1.3-.6,2.91,2.91,0,0,0-2.94,2,21.1,21.1,0,0,1-3.85,5.5,42.39,42.39,0,0,1-7.39,6.24c-.35.22-.82.17-.77-.29.1-.72.88-5.61,1-7.06.22-2.34-1.05-3.4-2.46-3.59-1.17-.16-2.94.17-3.91,2.82a58.9,58.9,0,0,0-2.75,8.2,24.94,24.94,0,0,0-.18,10.12,1,1,0,0,1-.13.68,40.56,40.56,0,0,0-2.53,4.39,1.24,1.24,0,0,0,.51,1.59,1.15,1.15,0,0,0,.59.15,1.21,1.21,0,0,0,1.11-.7c.38-.79,1.15-2.27,1.45-2.89a20.69,20.69,0,0,0,1-2.22,3.37,3.37,0,0,0,0-2,20.19,20.19,0,0,1,.2-8.17A86.35,86.35,0,0,1,277,78.16c.3-.73.72-1,1.14-.92s1.23.24,1,1.73c-.41,2.67-1,6.07-1.19,7.21a2.32,2.32,0,0,0,.84,2.47c.81.47,1.7.21,2.68-.45A50.13,50.13,0,0,0,289.9,81a19.79,19.79,0,0,0,4-6,1.14,1.14,0,0,1,1.32-.62c.27.08.59.44.36,1.21-.56,1.85-2.85,6.1-7.28,10.08a.86.86,0,0,0-.18,1.26.83.83,0,0,0,1.22,0,29.12,29.12,0,0,0,7.28-9.59,17.29,17.29,0,0,0,.87-2.22,1,1,0,0,1,1-.78c.49.1.81.59.65,1.41a14.17,14.17,0,0,1-1.08,3,41.9,41.9,0,0,1-6.88,9.42.81.81,0,0,0,0,1.19c.39.37.85.21,1.27-.19a37.71,37.71,0,0,0,7-9.27.87.87,0,0,1,1.13-.55c.56.22.55,1.17,0,2.2a34.92,34.92,0,0,1-6.82,9.51.75.75,0,0,0,0,1.13c.32.28.84.27,1.33-.23a39.44,39.44,0,0,0,4.27-5,.94.94,0,0,1,1-.5c.48.1.55.55.41,1.11-.24.89-2.76,4.18-3.76,5.29" />
              <path d="M273.4,76h0c.16-.13.1-.3.05-.43-.22-.67-1.48-3.44-1.81-4a.47.47,0,0,0-.61-.24,4.78,4.78,0,0,0-1.23.83,4.56,4.56,0,0,0-1,1,.41.41,0,0,0,.17.6c.55.38,3.32,1.92,4,2.21.14.06.31.14.47,0" />
              <path d="M271.55,77.52a42.05,42.05,0,0,0-4.33-.66.42.42,0,0,0-.5.38,5.29,5.29,0,0,0,.11,1.51,5,5,0,0,0,.38,1.46.42.42,0,0,0,.6.18c.59-.26,3.27-1.78,3.85-2.19.12-.08.27-.18.24-.39h0c0-.21-.21-.24-.35-.28" />
              <path d="M297.1,105.52c-.19-.62-1.39-3.45-1.73-4.07-.07-.12-.16-.28-.36-.27h0c-.21,0-.27.18-.32.32a40.61,40.61,0,0,0-1.14,4.25.42.42,0,0,0,.32.54,8.34,8.34,0,0,0,3-.19.43.43,0,0,0,.25-.58" />
              <path d="M300,103.42a.41.41,0,0,0,.62,0,4.55,4.55,0,0,0,.79-1.24,4.78,4.78,0,0,0,.54-1.37.43.43,0,0,0-.37-.51,43.48,43.48,0,0,0-4.38-.73c-.14,0-.32,0-.41.16h0c-.1.18,0,.32.11.44.44.56,2.6,2.81,3.1,3.23" />
              <path d="M330.31,115.22l-43.43,25V122a2.12,2.12,0,0,0-4.23,0v18.27l-43.43-25v-50l15.87,9.14a2.09,2.09,0,0,0,1,.28,2.11,2.11,0,0,0,1.06-3.93l-15.86-9.14,43.43-25,43.43,25-15.87,9.14a2.11,2.11,0,0,0,1.06,3.93,2.16,2.16,0,0,0,1.06-.28l15.86-9.14Zm4.21-53.75a1.65,1.65,0,0,0,0-.38.5.5,0,0,0,0-.13,1.66,1.66,0,0,0-.19-.46,2,2,0,0,0-.3-.4l-.1-.09a3,3,0,0,0-.3-.23l-.07-.05L285.82,32.28a2.14,2.14,0,0,0-2.11,0L236.05,59.73l-.06,0a2.34,2.34,0,0,0-.31.24l-.09.09a2,2,0,0,0-.31.4,2.62,2.62,0,0,0-.19.46l0,.13a2.47,2.47,0,0,0-.05.38s0,.06,0,.08v54.89a2.12,2.12,0,0,0,1.05,1.83l47.66,27.44.08,0a2.17,2.17,0,0,0,.35.15l.13,0a2.07,2.07,0,0,0,.5.06,2,2,0,0,0,.49-.06l.13,0a2.28,2.28,0,0,0,.36-.15l.07,0,47.66-27.44a2.12,2.12,0,0,0,1-1.83V61.55s0,0,0-.08Z" />
              <path d="M284.77,48.82A1.84,1.84,0,1,1,286.6,47a1.84,1.84,0,0,1-1.83,1.84m0-6.15A4.31,4.31,0,1,0,289.09,47a4.33,4.33,0,0,0-4.32-4.31" />
              <path d="M321.5,107.59a1.84,1.84,0,1,1-1.84,1.84,1.84,1.84,0,0,1,1.84-1.84m-4.33,1.84a4.33,4.33,0,1,0,4.33-4.32,4.33,4.33,0,0,0-4.33,4.32" />
              <path d="M248.39,108.11a1.84,1.84,0,1,1-1.83,1.83,1.83,1.83,0,0,1,1.83-1.83m-4.32,1.83a4.33,4.33,0,1,0,4.32-4.31,4.33,4.33,0,0,0-4.32,4.31" />
              <!-- eslint-enable max-len -->
            </g>
            <circle cx="258.57" cy="115.85" r="2" />
            <circle cx="267.3" cy="120.9" r="2" />
            <circle cx="276.04" cy="125.96" r="2" />
            <circle cx="310.99" cy="115.85" r="2" />
            <circle cx="302.25" cy="120.9" r="2" />
            <circle cx="293.51" cy="125.96" r="2" />
            <circle cx="310.98" cy="62.09" r="2" />
            <circle cx="302.25" cy="57.03" r="2" />
            <circle cx="293.51" cy="51.98" r="2" />
            <circle cx="258.57" cy="62.09" r="2" />
            <circle cx="267.3" cy="57.03" r="2" />
            <circle cx="276.04" cy="51.98" r="2" />
            <circle cx="248.39" cy="98.18" r="2" />
            <circle cx="248.39" cy="88.1" r="2" />
            <circle cx="248.39" cy="78.02" r="2" />
            <circle cx="321.5" cy="98.18" r="2" />
            <circle cx="321.5" cy="88.1" r="2" />
            <circle cx="321.5" cy="78.02" r="2" />
          </g>
        </svg>
        <h1 class="headline font-weight-medium text-center mb-12">
          {{ $t('App.title') }}
        </h1>
      </v-col>
    </v-row>
    <v-card
      class="mx-auto mt-n12"
      max-width="480px"
      flat
    >
      <v-stepper
        v-model="currentStep"
        vertical
      >
        <v-stepper-step :step="1" :complete="currentStep >= 1">
          <span class="text-center">{{ $t('App.step.0') }}</span>
        </v-stepper-step>
        <v-stepper-content :step="1">
          <div v-if="error" class="error--text">
            <v-icon
              class="mr-1"
              color="error"
            >
              mdi-alert
            </v-icon>
            <a
              v-if="error.message === 'USER_HAS_NO_COSMOS_WALLET'"
              :href="`${LIKECO_HOST}/in/migration/authcore`"
              class="error--text"
            >
              {{ $t('App.error.pleaseMigrateFirst') }}
            </a>
            <template v-else>
              {{ error }}
            </template>
          </div>
          <step-introduction
            v-else
            :is-liker-id="isLikerId"
            @confirm="onStart"
          />
        </v-stepper-content>

        <template v-if="!isLikerId">
          <v-stepper-step :step="2" :complete="currentStep >= 2">
            <span class="text-center">{{ $t('App.step.1') }}</span>
          </v-stepper-step>
          <v-stepper-content :step="2">
            <step-cosmos @confirm="setCosmosAddress" />
          </v-stepper-content>

          <v-stepper-step :step="3" :complete="currentStep >= 3">
            <span class="text-center">{{ $t('App.step.2') }}</span>
          </v-stepper-step>
          <v-stepper-content :step="3">
            <step-ethereum
              v-if="state === 'eth'"
              @confirm="setEthInformation"
            />
            <step-value-input
              v-else
              :wallet="ethAddress"
              :web3="web3"
              :max-value="maxMigrationValue"
              :is-ledger="isLedger"
              @change-eth-wallet="setEthInformation"
              @confirm="setMigrateValue"
            />
          </v-stepper-content>
        </template>

        <v-stepper-step
          :step="getStepFromState('sign')"
          :complete="currentStep >= getStepFromState('sign')"
        >
          <span class="text-center">{{ $t('App.step.3') }}</span>
        </v-stepper-step>
        <v-stepper-content :step="getStepFromState('sign')">
          <step-sign
            :liker-id="likerId"
            :avatar="avatar"
            :is-civic-liker="isCivicLiker"
            :eth-address="ethAddress"
            :cosmos-address="cosmosAddress"
            :value="migrateValue"
            :is-ledger="isLedger"
            :web3="web3"
            @confirm="setTxHash"
          />
        </v-stepper-content>

        <v-stepper-step
          :step="getStepFromState('pending-tx')"
          :complete="currentStep >= getStepFromState('pending-tx')"
        >
          <span class="text-center">{{ $t('App.step.4') }}</span>
        </v-stepper-step>
        <v-stepper-content :step="getStepFromState('pending-tx')">
          <step-pending-tx
            v-if="state === 'pending-tx'"
            :liker-id="likerId"
            :eth-address="ethAddress"
            :cosmos-address="cosmosAddress"
            :value="migrateValue"
            :processing-eth-tx-hash="processingEthTxHash"
            @reset="onReset"
            @done="onPostDone"
          />
        </v-stepper-content>
      </v-stepper>
    </v-card>
  </v-container>
</template>

<script>
import StepSign from '../components/StepSign.vue';
import StepPendingTx from '../components/StepPendingTx.vue';
import StepEthereum from '../components/StepEthereum.vue';
import StepValueInput from '../components/StepValueInput.vue';
import StepCosmos from '../components/StepCosmos.vue';
import StepIntroduction from '../components/StepIntroduction.vue';

import { logTrackerEvent } from '../util/EventLogger';
import {
  trySetLocalStorage,
  checkIsSafari,
  checkIsMobileClient,
} from '../util/client';
import * as eth from '../util/eth';
import { apiGetLikerId, apiGetCosmosBalance } from '../util/api';
import {
  ETH_MIN_LIKECOIN_AMOUNT,
  COSMOS_MIGRATION_ADDRESS,
  LIKECO_HOST,
} from '../constant';

const BigNumber = require('bignumber.js');

export default {
  components: {
    StepSign,
    StepPendingTx,
    StepEthereum,
    StepValueInput,
    StepCosmos,
    StepIntroduction,
  },
  data: () => ({
    LIKECO_HOST,
    error: '',
    isBegin: false,
    cosmosAddress: '',
    web3: null,
    ethAddress: '',
    ethBalance: '',
    migrateValue: '',
    processingEthTxHash: '',
    isLedger: false,
    likerId: '',
    avatar: '',
    isCivicLiker: false,
    migrateAccBalance: '',
  }),
  computed: {
    isLikerId() {
      return !!this.likerId;
    },
    state() {
      if (this.processingEthTxHash) { // overide all states
        return 'pending-tx';
      } if (!this.isBegin) {
        return 'introduction';
      } if (!this.cosmosAddress) {
        return 'cosmos';
      } if (!this.ethAddress || !this.ethBalance || !(this.web3 || this.isLikerId)) {
        return 'eth';
      } if (!this.migrateValue) {
        return 'value';
      } if (!this.processingEthTxHash) {
        return 'sign';
      }
      return 'introduction';
    },
    currentStep() {
      return this.getStepFromState(this.state);
    },
    maxMigrationValue() {
      return BigNumber.min(
        this.ethBalance,
        // minus 1 LIKE for transaction fee
        new BigNumber(this.migrateAccBalance).minus(1e18),
      ).toFixed();
    },
  },
  watch: {
    state(s) {
      if (this.isLikerId) {
        logTrackerEvent(this, 'ErcMigration', `GuestStateChangeTo${s}`, `GuestStateChangeTo${s}`);
      } else {
        logTrackerEvent(this, 'ErcMigration', `LikerStateChangeTo${s}`, `LikerStateChangeTo${s}`);
      }
    },
  },
  async mounted() {
    if (checkIsMobileClient()) {
      this.error = this.$t('App.error.pleaseUseDesktop');
      return;
    }
    if (checkIsSafari()) {
      this.error = this.$t('App.error.dontUseSafari');
      return;
    }
    const { likerid } = this.$route.query;
    if (likerid) {
      try {
        const { data } = await apiGetLikerId(likerid);
        const {
          wallet,
          cosmosWallet,
          // displayName,
          avatar,
          isCivicLikerTrial,
          isSubscribedCivicLiker,
        } = data;
        this.likerId = likerid;
        this.avatar = avatar;
        this.isCivicLiker = isCivicLikerTrial || isSubscribedCivicLiker;
        if (!wallet) throw new Error('USER_HAS_NO_WALLET');
        if (!cosmosWallet) throw new Error('USER_HAS_NO_COSMOS_WALLET');
        this.ethBalance = (await eth.getLikeCoinBalance(wallet)).toString();
        const roundedBalance = new BigNumber(this.ethBalance)
          .dividedBy(1e9)
          .integerValue(BigNumber.ROUND_DOWN)
          .multipliedBy(1e9);
        if (roundedBalance.lt(new BigNumber(ETH_MIN_LIKECOIN_AMOUNT))) {
          throw new Error('BALANCE_BELOW_MIN');
        }
        this.migrateValue = roundedBalance.toFixed();
        this.cosmosAddress = cosmosWallet;
        this.ethAddress = wallet;
      } catch (err) {
        console.error(err);
        if (err.response && err.response.status === 404) {
          this.error = 'USER_NOT_FOUND';
          return;
        }
        this.error = err;
      }
    }
    if (window.localStorage) {
      try {
        this.processingEthTxHash = window.localStorage.getItem('processingEthTxHash') || '';
        if (this.processingEthTxHash || this.processingCosmosTxHash) {
          this.cosmosAddress = window.localStorage.getItem('cosmosAddress') || '';
          this.ethAddress = window.localStorage.getItem('ethAddress') || '';
          this.migrateValue = window.localStorage.getItem('migrateValue') || '';
        }
      } catch (err) {
        // no op
      }
    }
    const rawMigrateAccBalance = (await apiGetCosmosBalance(COSMOS_MIGRATION_ADDRESS)).data.value;
    this.migrateAccBalance = new BigNumber(rawMigrateAccBalance).multipliedBy(1e18).toFixed();
  },
  methods: {
    getStepFromState(state) {
      switch (state) {
        case 'cosmos':
          return 2;

        case 'eth':
        case 'value':
          return 3;

        case 'sign':
          return this.isLikerId ? 2 : 4;

        case 'pending-tx':
          return this.isLikerId ? 3 : 5;

        default:
        case 'introduction':
          return 1;
      }
    },
    onStart() {
      this.isBegin = true;
    },
    setCosmosAddress(cosmosAddress) {
      trySetLocalStorage('cosmosAddress', cosmosAddress);
      this.cosmosAddress = cosmosAddress;
    },
    setEthInformation({
      ethAddress,
      ethBalance,
      web3,
      isLedger,
    }) {
      trySetLocalStorage('ethAddress', ethAddress);
      this.ethAddress = ethAddress;
      this.web3 = web3;
      this.isLedger = isLedger;
      this.ethBalance = ethBalance;
    },
    setMigrateValue(migrateValue) {
      trySetLocalStorage('migrateValue', migrateValue);
      this.migrateValue = migrateValue;
    },
    setTxHash(txHash) {
      trySetLocalStorage('processingEthTxHash', txHash);
      this.processingEthTxHash = txHash;
    },
    async onReset() {
      this.onPostDone();
      this.isBegin = false;
      this.web3 = null;
      this.ethAddress = '';
      this.ethBalance = 0;
      this.cosmosAddress = '';
      this.migrateVale = 0;
      this.processingEthTxHash = '';
      this.processingCosmosTxHash = '';
    },
    async onPostDone() {
      if (window.localStorage) {
        try {
          window.localStorage.removeItem('processingEthTxHash');
          window.localStorage.removeItem('processingCosmosTxHash');
        } catch (err) {
          // no op
        }
      }
    },
  },
};
</script>
